name: Deploy to Server

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.OCI_APP_HOST }}
          username: ${{ secrets.OCI_APP_USERNAME }}
          key: ${{ secrets.OCI_APP_KEY }}
          script: |
            set -e

            REPO_DIR="/home/ubuntu/genie"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            VERSION="${{ steps.version.outputs.VERSION }}"

            echo "ğŸš€ ë°°í¬ ì‹œì‘: $VERSION"

            # ì €ì¥ì†Œ í´ë¡  ë˜ëŠ” ì—…ë°ì´íŠ¸
            if [ ! -d "$REPO_DIR" ]; then
              echo "ğŸ“¥ ì €ì¥ì†Œ í´ë¡  ì¤‘..."
              git clone "$REPO_URL" "$REPO_DIR"
            else
              echo "ğŸ”„ ì €ì¥ì†Œ ì—…ë°ì´íŠ¸ ì¤‘..."
              cd "$REPO_DIR"
              git fetch --all --tags
            fi

            # ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd "$REPO_DIR"

            # íŠ¹ì • íƒœê·¸ë¡œ ì²´í¬ì•„ì›ƒ
            echo "ğŸ“Œ íƒœê·¸ ì²´í¬ì•„ì›ƒ: $VERSION"
            git checkout "tags/$VERSION"

            # íŒŒì¼ ì†Œìœ ê¶Œ í™•ì¸ ë° ìˆ˜ì •
            echo "ğŸ” íŒŒì¼ ì†Œìœ ê¶Œ í™•ì¸ ì¤‘..."
            sudo chown -R ubuntu:ubuntu "$REPO_DIR"
            
            # ì„œë¸Œëª¨ë“ˆ ì—…ë°ì´íŠ¸
            echo "ğŸ“¦ ì„œë¸Œëª¨ë“ˆ ì—…ë°ì´íŠ¸ ì¤‘..."
            git submodule update --init --recursive

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "âš™ï¸  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
            chmod +x deploy.sh
            ./deploy.sh

            echo "âœ… ë°°í¬ ì™„ë£Œ: $VERSION"
